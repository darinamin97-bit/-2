## Техническое видение: «Ниндзя‑файтинг» (онлайн, P2P, 1v1)

Документ основан на `idea.md` и описывает технические решения для MVP и дальнейшего развития.

### Технологии
- **Язык и платформа**: TypeScript, браузерное приложение (SPA) на Vite.
- **Рендер/движок**: Phaser 3 (альтернатива: PixiJS) для 2D side‑scroll боя.
- **Сеть (P2P)**: WebRTC DataChannels для обмена входами/состоянием; libp2p (браузер) для peer discovery/pub‑sub (Gossipsub) и сигналинга.
  - Допускается минимальная инфраструктура: публичные STUN и один/несколько публичных сигнальных bootstrap‑узлов (не являются центральным игровым сервером).
  - TURN — только как редкий фолбэк, вне MVP.
- **Синхронизация**: Lockstep/rollback неткод (в духе GGPO) с детерминированной симуляцией и фиксированным тайм‑степом.
- **Хранение**: IndexedDB/LocalStorage для профиля и настроек. Для распределённых данных (позже) — OrbitDB/libp2p‑datastore или Yjs (CRDT) поверх pub‑sub.
- **Сборка/тесты**: ESLint + Prettier, Vitest (юнит/интеграция), Playwright (e2e), GitHub Actions.

### Принципы разработки
- **MVP‑first**: минимально жизнеспособный онлайновый бой 1v1 без центрального сервера.
- **Детерминизм ядра**: симуляция отделена от рендера, без плавающих таймеров/рандома без сидов.
- **Тест‑пирамида**: юнит‑тесты ядра, net‑sync тесты с симуляцией задержек/потерь, e2e боёв.
- **Модульность**: разделение на game‑core, net‑sync, matchmaking, ui, storage.
- **Качество**: типобезопасность, линт, форматирование, pre‑commit hooks, Conventional Commits.

### Структура проекта (MVP)
- `src/game` — ядро симуляции (физика, стейты, команды, коллизии).
- `src/ui` — сцены Phaser, HUD, меню.
- `src/net` — транспорт (WebRTC), протокол сообщений, синхронизация кадров.
- `src/matchmaking` — обнаружение/поиск пиров, фильтры по уровню и клану.
- `src/storage` — профиль игрока, сохранение W/L, клан.
- `src/config` — типизированная конфигурация (env + runtime JSON).
- `src/telemetry` — логирование, метрики/трейсы (расширяемо).
- `public/` — статические ассеты.

### Архитектура (высокоуровнево)
- **UI/рендер**: Phaser сцены управляют визуализацией, не влазят в логику боя.
- **Game‑core**: чистые функции, детерминированные апдейты по входам, сидируемый RNG.
- **Net‑sync**: обмен входами (input delay) или компактными дельтами состояния; откаты по хэшам состояний при расхождении.
- **Matchmaking (децентрализованный)**: пирамидальная подписка на темы уровня (bucket), публикация присутствия; фильтр по клану; случайный выбор соперника в подходящем bucket.
- **Идентичность**: ключ пары (Ed25519) на клиенте, подпись матч‑результатов для взаимной верификации (без центральной арбитрации в MVP).

### Модель данных (упрощённо)
```ts
type Clan = 'A' | 'B';

type PlayerIdentity = {
  playerId: string;        // стабильный UUID, привязанный к публичному ключу
  publicKey: string;       // Ed25519, base58/base64
};

type PlayerProfile = {
  identity: PlayerIdentity;
  clan: Clan;              // назначается однажды при регистрации
  wins: number;
  losses: number;
};

type LevelBucket = number; // например, floor((wins - losses)/N), или ELO‑корзина

type Presence = {
  playerId: string;
  levelBucket: LevelBucket;
  clan: Clan;
  timestamp: number;
  offer: RTCSessionDescriptionInit | null; // опционально, для ускорения сигналинга
};

type MatchRecord = {
  matchId: string;
  players: [string, string]; // playerIds
  winner: string | null;     // null до окончания
  stateHashes: string[];     // контрольные хэши кадров
  signedBy: string[];        // подписи сторон на результате
};
```

### Сценарии работы
- **Регистрация**: генерируется ключ, игроку случайно назначается клан A/B, профиль сохраняется локально.
- **Поиск матча**: клиент публикует `Presence` в топике своего `levelBucket`, подписывается на входящие.
- **Фильтрация**: игнорируются пэры того же клана; выбирается случайный кандидат подходящего уровня.
- **Сигналинг/соединение**: обмен SDP/ICE через pub‑sub/сигнальный bootstrap, STUN для обхода NAT.
- **Старт боя**: синхронизация seed и начального состояния; ввод по кадрам, откаты при рассинхронизации.
- **Завершение**: стороны подписывают результат, локально обновляют W/L и новый `levelBucket`.

### Деплой
- **Хостинг**: статический (CDN) — Cloudflare Pages/Netlify/Vercel, без серверной логики.
- **Bootstrap/Signal**: один или несколько публичных узлов для сигналинга (WebSocket/WebRTC‑star) и список STUN. Это не центральный игровой сервер.
- **Версионирование протокола**: семантические версии; клиенты разных major‑версий не соединяются.

### Подход к конфигурированию
- **Источники**: `.env` для сборки, `config/runtime.json` для адресов bootstrap/STUN, таймингов неткода, флагов.
- **Типизация**: схема (zod/io‑ts) и валидация при старте.
- **Фичфлаги**: включение rollback, метрик, детального логирования.

### Подход к логированию
- **Структурированные логи**: JSON, уровни `error|warn|info|debug` с метками `matchId`, `peerId`, `frame`.
- **Диагностика неткода**: задержка/джиттер/потери, время откатов, дивергенции по хэшу состояния.
- **Конфиденциальность**: без PII; возможность экспорта логов пользователем.

### Ограничения и риски (MVP)
- **NAT/соединяемость**: без TURN часть пиров не свяжется; допускаем фолбэк позже.
- **Античит**: без авторитативного сервера возможны злоупотребления; смягчается детерминизмом, взаимной валидацией и реплеями.
- **Честность статистики**: в MVP — локальная; в дальнейшем — репликация и подписи результатов между пирами.
