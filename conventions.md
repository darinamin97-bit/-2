## Conventions: правила генерации и разработки кода

Этот документ задаёт краткие, обязательные правила для генерации и ревью кода. Детали и обоснования — в документе [vision.md](./vision.md). Здесь фиксируем только главное, влияющее на качество (KISS).

### Ориентиры качества
- **KISS и MVP‑first**: минимально достаточные решения, без преждевременной сложности. См. разделы MVP и архитектуры в `vision.md`.
- **Модульность и границы**: строгие слои и явные зависимости; запрет кросс‑импортов против архитектуры.
- **Детерминизм симуляции**: фиксированный тайм‑степ, посевной RNG, отсутствие wall‑clock в ядре.
- **Типобезопасность**: строгий TypeScript, явные типы публичных API, без `any` и небезопасных кастов.
- **Тестируемость**: ядро — тестами; неткод — под задержки/потери; e2e — дуэли.

### Архитектурные границы (не нарушать)
- **`src/game`**: чистые, детерминированные функции, фиксированный тик; побочные эффекты отсутствуют.
- **`src/ui`**: только рендер/ввод; без игровой логики и состояния симуляции.
- **`src/net`**: транспорт WebRTC и синхронизация; без игровых правил.
- **`src/matchmaking`**: поиск пиров, фильтры по уровню/клану; без централизованного сервера.
- **`src/storage`**: профиль, W/L, клан; без бизнес‑логики.
- **`src/config`**: все настройки и константы; никакого хардкода в коде.
- **`src/telemetry`**: структурированные логи/метрики; без PII.

Подробности и выбор технологий — в [vision.md](./vision.md).

### Код‑стайл и практики
- **Имена**: понятные, предметные; избегать 1–2‑символьных; функции — глаголы, данные — существительные.
- **Поток управления**: guard‑clauses и ранний return; глубина вложенности ≤ 3; избегать сложных тернарных выражений.
- **Исключения**: не использовать `try/catch` без реальной обработки; не глотать ошибки.
- **Комментарии**: только для неочевидной логики/инвариантов; не комментировать очевидное; без TODO — реализовывать сразу.
- **Магические числа**: заменить на именованные константы в конфиге/модуле.

### Форматирование и линт
- **ESLint + Prettier**: единый стиль, автофиксы обязательны.
- **Чистые правки**: не переформатировать несвязанный код; не смешивать рефакторинг и функциональные изменения.

### Тесты (минимум на PR)
- Юнит‑тесты для ядра (`src/game`) под фиксированным тиком и посевом.
- Интеграционные для неткода (`src/net`): задержки/джиттер/потери.
- E2E (по мере готовности): дуэль 1v1 по критериям из `vision.md`.

### Неткод и синхронизация
- Lockstep/rollback по `vision.md`: обмен входами/дельтами, хэши состояний, синхронизация seed.
- Никакого нефиксированного времени, таймеров и рандома без посева в ядре.

### Конфигурация
- Все параметры — из `src/config`, типизированы и валидируются (zod/io‑ts). Никаких хардкод‑эндпоинтов.
- Разделять build‑time (`.env`) и runtime (`config/runtime.json`) конфигурации. Фичфлаги — через конфиг.

### Логирование
- Структурированное JSON‑логирование: уровни `error|warn|info|debug`; ключи `matchId`, `peerId`, `frame`.
- Конфиденциальность: без персональных данных; объём и уровни — настраиваемые.

### Коммиты и изменения
- Conventional Commits; маленькие, атомарные PR; без смешения форматирования и логики.
- Перед PR: линт/тесты зелёные; изменения протокола — с версионированием.

### Запрещено
- Логика боя в `ui`/`net`/`storage` слоях.
- Плавающие таймеры/непосевной рандом в `src/game`.
- Глобальное состояние без сильного обоснования.
- Тихая обработка ошибок и скрытое изменение протокола.

Для любого неочевидного решения сначала свериться с [vision.md](./vision.md) и не дублировать его — следовать указанным там принципам и ограничениям.